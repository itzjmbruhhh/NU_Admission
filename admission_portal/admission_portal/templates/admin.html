{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Smart Admission — Admin Dashboard</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'css/admin_chart.css' %}" />
  </head>
  <body>
    <div class="admin-page">
      <!-- Header -->
      <header class="header">
        <div class="header-content">
          <div class="header-left">
            <div class="header-title">
              <h1>Smart Admission System</h1>
              <p>Admin Dashboard</p>
            </div>
          </div>
          <nav class="header-nav">
            <span class="nav-link active"
              ><i class="fas fa-tachometer-alt"></i> Dashboard</span
            >
            <span class="nav-link" id="adminName">Welcome, Admin!</span>
          </nav>
        </div>
      </header>

      <!-- Floating Logout -->
      <a href="#" class="floating-admin-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>

      <main class="dashboard-container">
        <!-- Section Navigation -->
        <section class="section-tabs">
          <button class="tab-btn" onclick="showSection('search')">
            <i class="fas fa-search"></i> Student Records
          </button>
          <button class="tab-btn active" onclick="showSection('overview')">
            <i class="fas fa-chart-line"></i> Overview & Analytics
          </button>
        </section>

        <!-- ✅ Overview Section -->
        <div id="overview" class="section-content active">
          <!-- Summary Cards -->
          <section class="summary-grid">
            <div class="summary-card primary">
              <div class="card-icon"><i class="fas fa-users"></i></div>
              <div class="card-content">
                <h2>{{ current_enrolled_count }}</h2>
                <p>Enrolled Students ({{ current_year }})</p>
                <span class="trend {% if percent_change >= 0 %}up{% else %}down{% endif %}"
                  ><i class="fas fa-arrow-{% if percent_change >= 0 %}up{% else %}down{% endif %}"></i> {{ percent_change|floatformat:1 }}% from last year</span>
              </div>
            </div>
            <div class="summary-card success">
              <div class="card-icon"><i class="fas fa-male"></i></div>
              <div class="card-content">
                <h2>{{ male_enrolled_count }}</h2>
                <p>Male Students</p>
                <span class="trend neutral">{{ male_enrolled_percent|floatformat:1 }}% of total</span>
              </div>
            </div>

            <div class="summary-card warning">
              <div class="card-icon"><i class="fas fa-female"></i></div>
              <div class="card-content">
                <h2>{{ female_enrolled_count }}</h2>
                <p>Female Students</p>
                <span class="trend neutral">{{ female_enrolled_percent|floatformat:1 }}% of total</span>
              </div>
            </div>

            <div class="summary-card info">
              <div class="card-icon"><i class="fas fa-graduation-cap"></i></div>
              <div class="card-content">
                <h2>{{ top_program|default:'N/A' }}</h2>
                <p>Top Program</p>
                <span class="trend up">
                  <i class="fas fa-star"></i> Most popular
                  {% if top_program_count %}<br><small>({{ top_program_count }} enrolled)</small>{% endif %}
                </span>
              </div>
            </div>

          </section>

          <!-- Charts Grid -->
          <section class="charts-grid">

            <!-- Academic Year Distribution -->
            <div class="chart-container medium">
              <div class="chart-header">
                <h3>
                  <i class="fas fa-calendar-alt"></i> Academic Year Distribution
                </h3>
              </div>
              <canvas id="yearChart"></canvas>
            </div>
            {% load static %}
            {{ academic_year_labels|json_script:"academic-year-labels" }}
            {{ academic_year_data|json_script:"academic-year-data" }}

            <!-- Program Popularity (Pie with %) -->
            <div class="chart-container medium">
              <div class="chart-header">
                <h3><i class="fas fa-book"></i> Program Popularity</h3>
              </div>
              <canvas id="programChart"></canvas>
            </div>
            {{ program_labels|json_script:"program-labels" }}
            {{ program_data|json_script:"program-data" }}

            <!-- Admission Success Rate -->
            <div class="chart-container medium">
              <div class="chart-header">
                <h3>
                  <i class="fas fa-percentage"></i> Admission Success Rate
                </h3>
              </div>
              <canvas id="admissionChart"></canvas>
            </div>
            {{ admission_labels|json_script:"admission-labels" }}
            {{ admission_data|json_script:"admission-data" }}
          </section>
        </div>

        <!-- ✅ Student Records Section -->
        <div id="search" class="section-content">
          <section class="search-section">
            <div class="search-header">
              <h3><i class="fas fa-search"></i> Advanced Student Search</h3>
            </div>
            <div class="search-filters">
              <form method="get" class="filter-form">
                <div class="filter-row">
                  <div class="filter-group">
                    <label>Student ID</label>
                    <input type="text" name="student_id" value="{{ request.GET.student_id }}" placeholder="Enter Student ID" style="height:47px;padding:4px 8px;font-size:15px;" />
                  </div>
                  <div class="filter-group">
                    <label>Program</label>
                    <select name="program">
                      <option value="">All Programs</option>
                      {% for p in programs %}
                        <option value="{{ p }}" {% if p == selected_program %}selected{% endif %}>{{ p }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="filter-group">
                    <label>Status</label>
                    <select name="status">
                      <option value="">All Statuses</option>
                      {% for s in statuses %}
                        <option value="{{ s }}" {% if s == selected_status %}selected{% endif %}>{{ s }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="filter-group">
                    <label>School Year</label>
                    <select name="school_year">
                      <option value="">All Years</option>
                      {% for y in school_years %}
                        <option value="{{ y }}" {% if y == selected_school_year %}selected{% endif %}>{{ y }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="filter-group">
                    <label>Enrollment Chance</label>
                    <select name="enroll_chance">
                      <option value="">All</option>
                      <option value="lt_40" {% if selected_enroll_chance == 'lt_40' %}selected{% endif %}>&lt; 40%</option>
                      <option value="gte_40" {% if selected_enroll_chance == 'gte_40' %}selected{% endif %}>&ge; 40%</option>
                      <option value="gte_70" {% if selected_enroll_chance == 'gte_70' %}selected{% endif %}>&ge; 70%</option>
                      <option value="gte_90" {% if selected_enroll_chance == 'gte_90' %}selected{% endif %}>&ge; 90%</option>
                    </select>
                  </div>
                </div>
                <br>
                  <div class="filter-actions">
                    <button type="submit" class="btn primary filterBtn" style="height:32px;padding:4px 16px;font-size:15px;">
                      <i class="fas fa-search"></i> Filter
                    </button>
                    <button type="button" class="btn secondary filterBtn" style="height:32px;padding:4px 16px;font-size:15px;" onclick="window.location.href='/adminDash'">
                      <i class="fas fa-refresh"></i> Reset
                    </button>
                  </div>
              </form>
            </div>
          </section>

          <section class="records-section">
            <div class="records-header">
              <h3><i class="fas fa-table"></i> Student Records</h3>
            </div>

            <!-- Student Table -->
            <div class="table-container">
              <table id="studentTable" class="modern-table">
                <thead>
                  <tr>
                    <th></th>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Program</th>
                    <th>Enrollment Chance</th>
                    <th>Status</th>
                    <th>School Year</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for student in students %}
                  <tr>
                    <td></td>
                    <td>{{ student.student_id }}</td>
                    <td>{{ student.name }}</td>
                    <td>
                      <span class="program-badge bscs"
                        >{{ student.program_first_choice }}</span
                      >
                    </td>
                    <td>
                      {% if student.enrollment_chance is not None %}
                        <span class="chance-badge high">{{ student.enrollment_chance|floatformat:2 }}%</span>
                      {% else %}
                        <span class="chance-badge" style="background:#ccc;color:#222;">N/A</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if student.status == 'Enrolled' %}
                        <span class="status-badge enrolled" style="background: #059669; color: #fff">Enrolled</span>
                      {% else %}
                        <span class="status-badge not-enrolled" style="background: #e65959; color: #fff">Not Enrolled</span>
                      {% endif %}
                    </td>
                    <td>{{ student.school_year }}</td>
                    <td class="action-buttons">
                      <a class="btn-icon view" href="{% url 'student_detail' student.pk %}">
                        <i class="fas fa-eye"></i>
                      </a>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="9">No student records found.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>

              <div id="noResults" class="no-results" style="display: none">
                <i class="fas fa-search"></i>
                <p>No results found for your search criteria.</p>
              </div>
            </div>

            <!-- Pagination -->
            <div class="pagination">
              {% if students.has_previous %}
              <a
                class="btn secondary"
                href="?{% if selected_program %}program={{ selected_program }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}{% if selected_school_year %}school_year={{ selected_school_year }}&{% endif %}{% if selected_enroll_chance %}enroll_chance={{ selected_enroll_chance }}&{% endif %}{% if request.GET.student_id %}student_id={{ request.GET.student_id }}&{% endif %}page={{ students.previous_page_number }}"
              >
                <i class="fas fa-chevron-left"></i> Previous
              </a>
              {% else %}
              <span class="btn secondary" disabled>
                <i class="fas fa-chevron-left"></i> Previous
              </span>
              {% endif %}
              <span class="page-info">Page {{ students.number }} of {{ students.paginator.num_pages}}</span>
              {% if students.has_next %}
              <a
                class="btn secondary"
                href="?{% if selected_program %}program={{ selected_program }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}{% if selected_school_year %}school_year={{ selected_school_year }}&{% endif %}{% if selected_enroll_chance %}enroll_chance={{ selected_enroll_chance }}&{% endif %}{% if request.GET.student_id %}student_id={{ request.GET.student_id }}&{% endif %}page={{ students.next_page_number }}"
              >
                Next <i class="fas fa-chevron-right"></i>
              </a>
              {% else %}
              <span class="btn secondary" disabled>
                Next <i class="fas fa-chevron-right"></i>
              </span>
              {% endif %}
            </div>
          </section>
        </div>

        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="{% static 'script/admin-dashboard.js' %}"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        if (
          window.location.pathname.includes('adminDash') ||
          window.location.search.match(/(program=|status=|school_year=|student_id=|page=)/)
        ) {
          if (typeof showSection === 'function') {
            showSection('search');
          }
        }
      });
    </script>
  </body>
</html>
