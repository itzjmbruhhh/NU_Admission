{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Smart Admission — Admin Dashboard</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'css/admin_chart.css' %}?{% now 'U' %}" />
  </head>
  <body>
    <div class="admin-page">
      <!-- Header -->
      <header class="header">
        <div class="header-content">
          <div class="header-left">
            <div class="header-title">
              <h1>Smart Admission System</h1>
              <p>Admin Dashboard</p>
            </div>
          </div>
          <nav class="header-nav">
            <span class="nav-link" id="adminName">Welcome, Admin!</span>
          </nav>
        </div>
      </header>

      <!-- Floating Logout -->
      <a href="#" class="floating-admin-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>

      <main class="dashboard-container">
        <!-- Section Navigation -->
        <section class="section-tabs">
          <button class="tab-btn" onclick="showSection('search')">
            <i class="fas fa-search"></i> Student Records
          </button>
          <button class="tab-btn active" onclick="showSection('overview')">
            <i class="fas fa-chart-line"></i> Overview & Analytics
          </button>
        </section>

        <!-- ✅ Overview Section -->
        <div id="overview" class="section-content active">
          <!-- Summary Cards -->
          <section class="summary-grid">
            <div class="summary-card primary">
              <div class="card-icon"><i class="fas fa-users"></i></div>
              <div class="card-content">
                <h2>{{ current_enrolled_count }}</h2>
                <p>Enrolled Students ({{ current_year }})</p>
                <span class="trend {% if percent_change >= 0 %}up{% else %}down{% endif %}"
                  ><i class="fas fa-arrow-{% if percent_change >= 0 %}up{% else %}down{% endif %}"></i> {{ percent_change|floatformat:1 }}% from last year</span>
              </div>
            </div>
            <div class="summary-card success">
              <div class="card-icon"><i class="fas fa-male"></i></div>
              <div class="card-content">
                <h2>{{ male_enrolled_count }}</h2>
                <p>Male Students</p>
                <span class="trend neutral">{{ male_enrolled_percent|floatformat:1 }}% of total</span>
              </div>
            </div>

            <div class="summary-card warning">
              <div class="card-icon"><i class="fas fa-female"></i></div>
              <div class="card-content">
                <h2>{{ female_enrolled_count }}</h2>
                <p>Female Students</p>
                <span class="trend neutral">{{ female_enrolled_percent|floatformat:1 }}% of total</span>
              </div>
            </div>

            <div class="summary-card info">
              <div class="card-icon"><i class="fas fa-graduation-cap"></i></div>
              <div class="card-content">
                <h2>{{ top_program|default:'N/A' }}</h2>
                <p>Top Program</p>
                <span class="trend up">
                  <i class="fas fa-star"></i> Most popular
                  {% if top_program_count %}<br><small>({{ top_program_count }} enrolled)</small>{% endif %}
                </span>
              </div>
            </div>

          </section>

          <!-- Charts Grid -->
          <section class="charts-grid">

            <!-- Academic Year Distribution -->
            <div class="chart-container medium">
              <div class="chart-header">
                <h3>
                  <i class="fas fa-calendar-alt"></i> Academic Year Distribution
                </h3>
              </div>
              <canvas id="yearChart"></canvas>
            </div>
            {% load static %}
            {{ academic_year_labels|json_script:"academic-year-labels" }}
            {{ academic_year_data|json_script:"academic-year-data" }}

            <!-- Program Popularity (Pie with %) -->
            <div class="chart-container medium">
              <div class="chart-header">
                <h3><i class="fas fa-book"></i> Program Popularity</h3>
              </div>
              <canvas id="programChart"></canvas>
            </div>
            {{ program_labels|json_script:"program-labels" }}
            {{ program_data|json_script:"program-data" }}

            <!-- Admission Success Rate -->
            <div class="chart-container medium">
              <div class="chart-header">
                <h3>
                  <i class="fas fa-percentage"></i> Admission Success Rate
                </h3>
              </div>
              <canvas id="admissionChart"></canvas>
            </div>
            {{ admission_labels|json_script:"admission-labels" }}
            {{ admission_data|json_script:"admission-data" }}
          </section>
        </div>

        <!-- ✅ Student Records Section -->
        <div id="search" class="section-content">
          <section class="search-section">
            <div class="search-header">
              <h3><i class="fas fa-search"></i> Advanced Student Search</h3>
            </div>
            <div class="search-filters">
              <form method="get" class="filter-form">
                <div class="filter-row">
                  <div class="filter-group">
                    <label>Student ID</label>
                    <input type="text" name="student_id" value="{{ request.GET.student_id }}" placeholder="Enter Student ID" style="height:47px;padding:4px 8px;font-size:15px;" />
                  </div>
                  <div class="filter-group">
                    <label>Program (First Choice)</label>
                    <select name="program">
                      <option value="">All Programs</option>
                      {% for p in programs %}
                        <option value="{{ p }}" {% if p == selected_program %}selected{% endif %}>{{ p }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="filter-group">
                    <label>Status</label>
                    <select name="status">
                      <option value="">All Statuses</option>
                      {% for s in statuses %}
                        <option value="{{ s }}" {% if s == selected_status %}selected{% endif %}>{{ s }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="filter-group">
                    <label>School Year</label>
                    <select name="school_year">
                      <option value="">All Years</option>
                      {% for y in school_years %}
                        <option value="{{ y }}" {% if y == selected_school_year %}selected{% endif %}>{{ y }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="filter-group enrollment">
                    <div></div>
                    <label>Enrollment Chance</label>
                    <select name="enroll_chance">
                      <option value="">All</option>
                      <option value="lt_40" {% if selected_enroll_chance == "lt_40" %}selected{% endif %}>Below 40%</option>
                      <option value="gte_40" {% if selected_enroll_chance == "gte_40" %}selected{% endif %}>40% and above</option>
                      <option value="gte_70" {% if selected_enroll_chance == "gte_70" %}selected{% endif %}>70% and above</option>
                      <option value="gte_90" {% if selected_enroll_chance == "gte_90" %}selected{% endif %}>90% and above</option>
                    </select>
                  </div>
                  <div class="filter-group student-type">
                    <label>Student Type</label>
                    <select name="student_type">
                      <option value="">All Types</option>
                      <option value="Full-time Student" {% if selected_student_type == "Full-time Student" %}selected{% endif %}>Full-time Student</option>
                      <option value="Working Student" {% if selected_student_type == "Working Student" %}selected{% endif %}>Working Student</option>
                    </select>
                  </div>
            
                </div>
                <br>
                  <div class="filter-actions">
                    <button type="submit" class="btn primary filterBtn" style="height:32px;padding:4px 16px;font-size:15px;">
                      <i class="fas fa-search"></i> Filter
                    </button>
                    <button type="button" class="btn secondary filterBtn" style="height:32px;padding:4px 16px;font-size:15px;" onclick="window.location.href='/adminDash'">
                      <i class="fas fa-refresh"></i> Reset
                    </button>
                  </div>
              </form>
            </div>
          </section>

          <section class="records-section">
            <div class="records-header">
              <h3><i class="fas fa-table"></i> Student Records</h3>
            </div>

            <div class="table-container">
  <table id="studentTable" class="modern-table">
    <thead>
      <tr>
        <th>Student ID</th>
        <th>Full Name</th>        
        <th>Prefix</th>
        <th>Program (First Choice)</th>
        <th>Program (Second Choice)</th>
        <th>Enrollment Chance</th>
        <th>Status</th>
        <th>School Year</th>
        <th>School Term</th>
        <th>Campus Code</th>
        <th>Entry Level</th>
        <th>Age at Enrollment</th>
        <th>Birth Date</th>
        <th>Birth Place</th>
        <th>Birth City</th>
        <th>Gender</th>
        <th>Citizen of</th>
        <th>Religion</th>
        <th>Civil Status</th>
  <th>Complete Current Address</th>
  <th>Complete Permanent Address</th>
        <th>Disability</th>
        <th>Indigenous</th>
        <th>Birth Country</th>
        <th>Requirement Agreement</th>
        <th>Student Type</th>
        <th>Last School Attended</th>
        <th>School Type</th>
      </tr>
    </thead>
    <tbody>
      {% for student in students %}
      <tr>
        <td>{{ student.student_id }}</td>
        <td>{{ student.name }}</td>   
        <td>{{ student.prefix }}</td>
        <td>
          {% with pf=student.program_first_choice|default_if_none:""|upper %}
            {% if pf == 'BACHELOR OF SCIENCE IN NURSING' %}<span class="program-badge bsn" title="{{ student.program_first_choice }}">BSN</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN CIVIL ENGINEERING' %}<span class="program-badge bsce" title="{{ student.program_first_choice }}">BSCE</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN MEDICAL TECHNOLOGY' %}<span class="program-badge bsmt" title="{{ student.program_first_choice }}">BSMT</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN PSYCHOLOGY' %}<span class="program-badge bspsy" title="{{ student.program_first_choice }}">BSPSY</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN ACCOUNTANCY' %}<span class="program-badge bsa" title="{{ student.program_first_choice }}">BSA</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN INFORMATION TECHNOLOGY' %}<span class="program-badge bsit" title="{{ student.program_first_choice }}">BSIT</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN TOURISM MANAGEMENT' %}<span class="program-badge bstm" title="{{ student.program_first_choice }}">BSTM</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN ARCHITECTURE' %}<span class="program-badge bsarch" title="{{ student.program_first_choice }}">BSARCH</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN BUSINESS ADMINISTRATION MAJOR IN MARKETING MANAGEMENT' %}<span class="program-badge bsba-mktgmgt" title="{{ student.program_first_choice }}">BSBA-MKTGMGT</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN BUSINESS ADMINISTRATION MAJOR IN FINANCIAL MANAGEMENT' %}<span class="program-badge bsba-finmgt" title="{{ student.program_first_choice }}">BSBA-FINMGT</span>
            {% elif pf == 'BACHELOR OF SCIENCE IN COMPUTER SCIENCE' %}<span class="program-badge bscs" title="{{ student.program_first_choice }}">BSCS</span>
            {% else %}<span class="program-badge other" title="{{ student.program_first_choice }}">{{ student.program_first_choice }}</span>{% endif %}
          {% endwith %}
        </td>
        <td>
          {% with ps=student.program_second_choice|default_if_none:""|upper %}
            {% if not ps %}{% comment %}Empty second choice{% endcomment %}{% elif ps == 'BACHELOR OF SCIENCE IN NURSING' %}<span class="program-badge bsn" title="{{ student.program_second_choice }}">BSN</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN CIVIL ENGINEERING' %}<span class="program-badge bsce" title="{{ student.program_second_choice }}">BSCE</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN MEDICAL TECHNOLOGY' %}<span class="program-badge bsmt" title="{{ student.program_second_choice }}">BSMT</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN PSYCHOLOGY' %}<span class="program-badge bspsy" title="{{ student.program_second_choice }}">BSPSY</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN ACCOUNTANCY' %}<span class="program-badge bsa" title="{{ student.program_second_choice }}">BSA</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN INFORMATION TECHNOLOGY' %}<span class="program-badge bsit" title="{{ student.program_second_choice }}">BSIT</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN TOURISM MANAGEMENT' %}<span class="program-badge bstm" title="{{ student.program_second_choice }}">BSTM</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN ARCHITECTURE' %}<span class="program-badge bsarch" title="{{ student.program_second_choice }}">BSARCH</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN BUSINESS ADMINISTRATION MAJOR IN MARKETING MANAGEMENT' %}<span class="program-badge bsba-mktgmgt" title="{{ student.program_second_choice }}">BSBA-MKTGMGT</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN BUSINESS ADMINISTRATION MAJOR IN FINANCIAL MANAGEMENT' %}<span class="program-badge bsba-finmgt" title="{{ student.program_second_choice }}">BSBA-FINMGT</span>
            {% elif ps == 'BACHELOR OF SCIENCE IN COMPUTER SCIENCE' %}<span class="program-badge bscs" title="{{ student.program_second_choice }}">BSCS</span>
            {% else %}<span class="program-badge other" title="{{ student.program_second_choice }}">Other</span>{% endif %}
          {% endwith %}
        </td>
        <td>
          {% if student.enrollment_chance is not None %}
            <span class="enrollment-chance good">{{ student.enrollment_chance|floatformat:2 }}%</span>
          {% else %}
            <span class="enrollment-chance na">N/A</span>
          {% endif %}
        </td>
        <td>
          {% if student.status == 'Enrolled' %}
            <span class="status-badge enrolled">Enrolled</span>
          {% else %}
            <span class="status-badge not-enrolled">Not Enrolled</span>
          {% endif %}
        </td>
        <td>{{ student.school_year }}</td>
        <td>{{ student.school_term }}</td>
        <td>{{ student.campus_code }}</td>
        <td>{{ student.entry_level }}</td>
        <td>{{ student.age_at_enrollment }}</td>
        <td>{{ student.birth_date }}</td>
        <td>{{ student.birth_place }}</td>
        <td>{{ student.birth_city }}</td>
        <td>{{ student.gender }}</td>
        <td>{{ student.citizen_of }}</td>
        <td>{{ student.religion }}</td>
        <td>{{ student.civil_status }}</td>
        <td class="address-cell">
          {% with parts="" %}
            {% firstof student.current_street "" %}{% if student.current_brgy %}, {{ student.current_brgy }}{% endif %}{% if student.current_city %}, {{ student.current_city }}{% endif %}{% if student.current_province %}, {{ student.current_province }}{% endif %}{% if student.current_region %}, {{ student.current_region }}{% endif %}{% if student.current_postal_code %} {{ student.current_postal_code }}{% endif %}
          {% endwith %}
        </td>
        <td class="address-cell">
          {% with parts="" %}
            {% firstof student.permanent_street "" %}{% if student.permanent_brgy %}, {{ student.permanent_brgy }}{% endif %}{% if student.permanent_city %}, {{ student.permanent_city }}{% endif %}{% if student.permanent_province %}, {{ student.permanent_province }}{% endif %}{% if student.permanent_region %}, {{ student.permanent_region }}{% endif %}{% if student.permanent_country %}, {{ student.permanent_country }}{% endif %}{% if student.permanent_postal_code %} {{ student.permanent_postal_code }}{% endif %}
          {% endwith %}
        </td>
        <td>
          {% if student.disability|stringformat:"s" == "1" %}Disabled{% else %}None{% endif %}
        </td>
        <td>
          {% if student.indigenous|stringformat:"s" == "1" %}Indigenous{% else %}None{% endif %}
        </td>
        <td>{{ student.birth_country }}</td>
        <td>
          {% if student.requirement_agreement|stringformat:"s" == "1" %}Yes{% else %}No{% endif %}
        </td>
        <td>{{ student.student_type }}</td>
        <td>{{ student.last_school_attended }}</td>
        <td>{{ student.school_type }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="45">No student records found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>



       <!-- Pagination -->
<div class="pagination">
  {% if students.has_previous %}
  <a class="btn secondary" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ students.previous_page_number }}">

    <i class="fas fa-chevron-left"></i> Previous
  </a>
  {% else %}
  <span class="btn secondary" disabled>
    <i class="fas fa-chevron-left"></i> Previous
  </span>
  {% endif %}
  <span class="page-info">Page {{ students.number }} of {{ students.paginator.num_pages}}</span>
  {% if students.has_next %}
  <a class="btn secondary" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ students.next_page_number }}">

    Next <i class="fas fa-chevron-right"></i>
  </a>
  {% else %}
  <span class="btn secondary" disabled>
    Next <i class="fas fa-chevron-right"></i>
  </span>
  {% endif %}
</div>
     

        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="{% static 'script/admin-dashboard.js' %}"></script>
    <script>
      function getProgramAbbreviation(name) {
        const map = {
          "Bachelor of Science in Psychology": "BPSY",
          "Bachelor of Science in Nursing": "BSN",
          "Bachelor of Science in Medical Technology": "BSMT",
          "Bachelor of Science in Information Technology": "BSIT",
          "Bachelor of Science in Information Technology with specilization in Mobile and Web Applications": "BSIT",
          "Bachelor of Science in Computer Science": "BSCS",
          "Bachelor of Science in Civil Engineering": "BSCE",
          "Bachelor of Science in Architecture": "BSARCH",
          "Bachelor of Science in Tourism Management": "BSTM",
          "Bachelor of Science in Business Administration major in Marketing Management": "BSBA-MktgMgt",
          "Bachelor of Science in Business Administration major in Financial Management": "BSBA-FinMgt",
          "Bachelor of Science in Accountancy": "BSA"
        };
        return map[name] || name;
      }
      document.addEventListener('DOMContentLoaded', function () {
        // Section tab activation
        if (
          window.location.pathname.includes('adminDash') ||
          window.location.search.match(/(program=|status=|school_year=|student_id=|page=)/)
        ) {
          if (typeof showSection === 'function') {
            showSection('search');
          }
        }
        // Convert top program to abbreviation
        var topProgramElem = document.querySelector('.summary-card.info .card-content h2');
        if (topProgramElem) {
          topProgramElem.textContent = getProgramAbbreviation(topProgramElem.textContent.trim());
        }
      });
    </script>
  </body>
</html>
